### Polkadot XCMP

Polkadot中消息传递可以简单分为两大类：水平消息传递（HMP）和垂直消息传递（VMP）。水平消息传递发生在平行链之间，其实就是XCMP；垂直消息传递发生在平行链和终极链之间。而VMP包括上传UMP和下传DMP两种方式。

XCMP(Cross-Chain Message Passing)主要用于平行链与平行链之间消息通信传递机制。在此过程中要尽量减少中继链的消耗。



要深刻理解波卡的共享安全机制，就要理解底层的消息通信，链与链之间的消息可以做到可验证，也就是可信的程度，但可信并不代表安全，比如一条只有几个节点达成共识的链的消息，传递过来是可以验证的，但因为其网络价值不足以保证安全，所以如果是这样的链之间进行通信，那价值网络会有很多安全黑洞。所以为了解决这个问题，就需要进行波卡的共享安全来保证，也就是接入波卡的平行链无论如何都需要付出一定的代价，不管是平行链拍卖，还是平行线程的抢购，只有这样才能将各个链之间的安全差异尽可能拉高到一个基准线，而只要接入波卡的平行链协议，就不存在安全上的巨大差异，而只有合理与不合理的差异，而合理与否就需要博弈了。


而在XCMP之前，会有一个阉割版的方案先出来，那就是HRMP（Horizontally Relay-routed Message Passing），与XCMP不同在于，他是将所有消息通过中继链来存储和中转，也就是说中继链的压力会比较大，但这只是早期的过度版本而已。

### XMP通信模型

- 异步性：发送者发送完消息后，该出块就出块，不需要管消息接下来如何的。
- 完备性：消息能够及时有序地传递和准确解释，中间不要对消息做手脚。
- 不对称性：消息并没有结果。返回的结果其实是另外一条消息了。
- 不可知性：消息对于传递消息的共识系统的性质是不可知的。传递消息是发生在平行链之间，还是平行链与转接桥之间，或者就是平行链与智能合约之间，消息是不需要知道的。

### 定义

- Consensus System：可以是链的，智能合约或者单个状态转换机的共识系统。这个共识系统只要能够发送和接收数据报。
- Location：可寻址的一个地址，比如国库地址，私人基金会地址，平行链地址，多签钱包地址等。
- Sovereign Account：一个被某个特定共识系统控制的账号，可以是一个账号或者多个账号，如果是多个账号，那多个账号指向一个单一主账号。
- Holding Account：一个临时的概念性“帐户”，其中暂时保留消息中固有的资产。
- Reserve location：保留地址，比如特定资产，在另外一个共识系统中有相应的一个衍生品，但原来的共识系统总能被衍生品所识别，而且在原来的共识系统中有一个主权账号，所以在原来共识系统中有衍生品的全部抵押品。
- Origin：消息发送源，从某个共识系统中传递消息出来，这个能够被接收者使用消息传递协议来查询。
- Recipient：消息接收源，某个共识系统中接收一个被传递到的消息。
- Teleport：传送，从一个地方销毁资产，在另外一个地方铸造相应资产，这就称为传送。传送的两个地方，在性质上没必要是一致的，一个地方可能是UTXO模型，另外一个地方可能是账号模型。传送发生的前提就是，双方有可信任的关系，包括状态转移函数STF，验证过程、finality过程和可用性都要是双方可信的。
- Transfer：从一个控制账号转移到另外一个账号的资产转移。这发生在同一类型的链，或者同样的整个资产所有权环境中，并且在相同的抽象级别内。比如同样用Substrate构建的链之间。

### 基础的消息格式

所有的数据都是SCALE编码，命名这些顶级消息XCM数据格式 `XcmPacket`。通常定义如下：

- `magic: [u8;2] = 0xff00`: 前缀符号。
- `version: Compact<u32>` : XCM版本号，目前支持0。
- `message: Xcm` : 消息体。

消息体格式：

- `type: u8`: 消息格式。
- `payload`: 消息参数。

消息格式有如下可选：

- 0: `WithdrawAsset`
- 1: `ReserveAssetTransfer`
- 2: `ReserveAssetCredit`
- 3: `TeleportAsset`
- 32: `RelayMessageParachain`
- 33: `ParachainRelayMessage`

在上面的消息格式里面，还有一个二级数据结构，是一些资产指令的包装， `Ai`, “Asset Instruction”,定义如下：

- `type: u8`: 指令类型。
- `payload` : 指令参数。

指令类型枚举在下面：

- 0: `DepositAsset` 
- 1: `ExchangeAsset`
- 2: `InitateReserveTransfer`
- 3: `InitiateTeleport`

#### 消息 ReserveAssetTransfer

这个消息指令就是指挥资产从一个有权限账号下转移到另外一个接收者账号。

这个消息指令下去后，一个 `ReserveAssetCredit`消息会被发送给目的地账号。

参数如下：

- `asset: MultiAsset` 被转移的资产。
- `destination: MultiDest` 资产转移目的地。
- `effect: Ai` 这个资产所携带的指令。

#### 消息 ReserveAssetCredit

这是一个传递到的通知消息，即消息发送源（保留资金账号）已将资金存入消息接收源拥有的主权账号。资产也将被铸造出来，并放入临时持有账号，并且如果有新的`effect`，则会被评估。

参数如下：

- `asset: MultiAsset` 被转移的资产。
- `effect:Ai` 资产所携带的指令。

#### TeleportAsset

一些可分割的资产从原来的消息发送源账号移除，并在接收者临时持有账号中铸造出来，如果消息资产携带新的指令，将会被评估。

参数如下：

- `asset: MultiAsset` 被借记的资产。
- `effect: Ai` 资产所携带的指令。

#### WithdrawAsset

原来消息发送源的主权账号，发送该消息到临时持有账号，要求清除相应资产，并且评估资产所携带的指令。

参数如下：

- `asset: MultiAsset` 被借记的资产。
- `effect: Ai` 资产所携带的指令。

#### RelayMessageParachain

指示性消息，中继链将消息中继到指定的目标链，其中实际消息呈现给目标链将会是`Parachain Relayed Message`格式，并且适当的保留消息发送源在里面。

参数如下：

- `destination: ParaId` 消息将要中继到的目标链。 
- `messages: Vec<Xcm>` 消息接收者将要解释的消息列表。


#### ParachainRelayMessage

平行链需要通过中继链给传递消息。

参数如下：

- `source: ParaId` 发出消息的平行链
- `messages: Vec<Xcm>` 消息接收者将要解释的消息列表。

#### Balances

跨链查询资产余额。

参数如下：

- `query_id` 将要把这个余额查询请求发送的链。
- `assets` 将要查询的资产列表。

### AssetInstruction 指令类型

todo

### MultiAsset 通用资产标识符

todo

### MultiLocation 通用地址标识符

todo








